# 背景条件

+ 假设每次输入 10 个问题，提供给攻击者
+ 假设攻击者成本体现在时间开销（小时），平均账号数量（个/家），算力开销（元）上
+ 攻击者工作流共有 4 步
+ 假设存在三个等级的 API ，API 提供商分类为国内和国外两类，具体如下表所示


|            | AMs（高级模型，$ level=3 $）                                                                                                                                | BMs（平衡模型，$ level=2 $）                                                                                                                                         | FMs（经济模型，$ level=1 $）                                                                                                                                                                                                                  |
| ---------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 国内服务商 | +<font style="background-color:rgb(249, 250, 251);">Qwen2.5-72B-Instruct</font><br/>+ <font style="background-color:rgb(249, 250, 251);">Deepseek-V3</font> | +<font style="background-color:rgb(249, 250, 251);">Qwen2.5-14B-Instruct</font><br/>+ <font style="background-color:rgb(249, 250, 251);">Qwen2.5-32B-Instruct</font> | +<font style="background-color:rgb(249, 250, 251);">Qwen2-7B-Instruct</font><br/>+ <font style="background-color:rgb(249, 250, 251);">Qwen2.5-7B-Instruct</font><br/>+ <font style="background-color:rgb(249, 250, 251);">GLM4-9B-chat</font> |
| 国外服务商 | +GPT-4o                                                                                                                                                     | +<font style="background-color:rgb(249, 250, 251);">GPT-4o-mini</font>                                                                                               |                                                                                                                                                                                                                                               |

# 攻击者结构化

## 1：问题处理方式

1. 攻击者偏向于串行处理每一个问题（当一个问题的各个步骤都处理完了再处理下一个）
2. 攻击者偏向于并行处理每一个问题（同时处理各个问题的最新未完成步骤）

## 2：服务商选择偏好

1. 攻击者倾向于选择同一个服务商（可能会有 API 价格优惠）
2. 攻击者倾向于选择不同的服务商（出于安全性考虑）
3. 攻击者随机选择服务商

# 防御策略结构化

## 1：API 犯罪足迹检测策略

1. 无策略：没有调用 API 的历史记录检测算法
2. 服务商内部名单：同一家服务商内部会对 API 调用记录进行检测
3. 半全局内部名单：几家服务商会共享 API 调用记录并进行联合检测（国内厂商联合检测，国外厂商联合检测）
4. 全局名单：所有服务商共同检测所有 API 调用记录

## 2：犯罪处理方式

1. 无处理：对尝试生成非法内容的 API 调用（后称非法调用）不做处理
2. 限制时间：时间上限制有非法调用的账号的使用
3. 限制权限：取消有非法调用的账号 API 使用权限

## 3：非法调用侦测方法

1. 基于失败次数进行内容检测
2. 基于贝叶斯算法进行意图检测
3. 混合检测

# 方案细节

## 1： 非法内容生成效果衡量

对于完整的 4 步工作流生成的有害内容，定义第$ i $步中采用的模型为$ model_i $，$ level(m)\in \{1,2,3\} $为模型$ m $的等级。用 4 步中每一步采用的模型等级的平均值作为生成效果的量化指标$ value $，即：

$ value=\frac{\sum_{i=1}^{4}level(model_i)}{4} $

## 2：非法调用检测方法在模拟中的实现

### 2.1 有害问题毒性量化指标

理论上讲，不同问题的毒性不同，因此被大语言模型拒绝的可能性也不同。因此为每个问题$ Q $分配毒性值$ toxic(Q)\in\{1,2,3,4\} $。每个阶段的问题具有的毒性值不一样，有些步骤可能会增加毒性值，有的步骤可能会减少毒性值。

### 2.2 基于失败次数的检测

假设每个大语言模型$ model $对于同一毒性值的问题$ Q $具有一个确定的拒绝概率$ P_{reject}(toxic(Q),model) $,则通过如下方式判定某次问题$ Q $是否被拒绝：

$ \frac{random.randint(1,10)}{10}\geq P_{reject}(toxic(Q),model) $

此时，如果 API 犯罪足迹检测策略为服务商内部名单策略，则当该服务商检测到$ N $次调用拒绝后，将该问题标记为有害问题；如果 API 犯罪足迹检测策略为半全局内部名单或全局内部名单，则当共享信息的服务商共检测到$ N $次调用拒绝后，将该问题标记为有害问题。

### 2.3 基于贝叶斯算法的意图检测

对于具有毒性值$ toxic(Q) $的问题$ Q $，定义其在第 1 步时被贝叶斯算法锁定为潜在不良意图问题的概率为：

$ P_{bayesian,1}=\frac{toxic(Q)}{16} $

其在第$ i\in\{2,3,4\} $步被贝叶斯算法锁定为潜在不良意图问题的概率为：

$ P_{bayesian,i}=\min(P_{bayesian,i-1}*\frac{toxic(Q)}{2},1) $

此时，如果 API 犯罪足迹检测策略为服务商内部名单策略，则当在某一步$ i $中满足：

$ P_{bayesian,i}\geq \frac{random.randint(1,10)}{10} $

时，将该问题标记为有害问题；如果 API 犯罪足迹检测策略为半全局内部名单或全局内部名单，则当共享信息的服务商的所有步骤中，某一步$ i $中满足：

$ P_{bayesian,i}\geq \frac{random.randint(1,10)}{10} $

时，将该问题标记为有害问题。

### 2.4 混合检测

同时进行基于失败次数的检测和基于贝叶斯算法的意图检测，如果任意其一将问题标记为有害问题，则将问题标记为有害问题。

## 3：成本计算

成本按照三个角度来计算：时间、算力开销和平均账户数量

### 3.1 用户画像和本地算力开销模拟

不同的用户会有不同的行为模式，行为模式的区别主要体现在可支配算力开销上。对于有钱的用户，高危问题可以直接采用本地算力回答，这会带来高算力开销。此时定义用户可用资金等级为$ assets(user)\in \{1,2,3\} $，则用户在如下两种情况种会采用本地算力回答问题$ Q $：

1. $ \frac{random.randint(1,10)}{10}\leq \min(\frac{toxic(Q)}{assets(user)}, \frac{assets(user)}{toxic(Q)}) $
2. 当问题已经被拒绝$ N-1 $次并且$ assets(user)=3 $

此时算力开销简化为一个常量$ cost $计入算力开销部分的成本

### 3.2 平均账户数量计算

当用户被封号后，用户会自动立即重新生成一个新的账号。在最后的成本结算阶段会计算用户使用过的服务商的总账号数和平均账号数，以平均账号数作为账户开销量化的指标
